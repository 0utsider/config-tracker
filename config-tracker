#!/bin/bash

# Include config file
. "$0.conf"

export GIT_DIR="$repo/.git"
export GIT_WORK_TREE="$repo"

#
# Runs first-time initialisation, such as creating the git repo, post-commit
# hooks and crontab entries.
#
init() {

	# Initialise git repo
	git init -q

	# Do an initial sync & commit
	sync
	commit

	# Install latest version of post-commit email hook
	cp "${0%/*}/contrib/post-commit" "$repo/.git/hooks/post-commit"
	chmod +x "$repo/.git/hooks/post-commit"

	# Install crontab entry if it doesn't already exist
	[ ! -e "/etc/cron.d/config-tracker" ] && cp "${0%/*}/contrib/cron" "/etc/cron.d/config-tracker"

	reconfigure
}

#
# Reconfigures git options, such as notification email destination.
#
reconfigure() {

	# Set the email address for notifications to go to
	git config hooks.mailinglist "$notification_emails"
}

#
# Calls rsync to scan for changed files (but doesn't update the repo).
#
scan() {
	rsync -av --dry-run --include-from="$include_file" --exclude-from="$exclude_file" "$working_root/" "$repo/"
}

#
# Syncs changed files to repo dir
#
sync() {
	rsync -a --include-from="$include_file" --exclude-from="$exclude_file" "$working_root/" "$repo/"
}

#
# Calls rsync to sync the files into the config working dir and commits the
# changes.
#
update() {
	reconfigure
	sync
	commit
}

#
# Commits changes in repo dir.
#
commit() {
	git add -A && git commit -q -m "Auto-commit" >/dev/null
}

#
# Pushes local config repo to remote/central repository.
#
#push() {
#}

if [ "$(type -t $1)" ]; then $1; else echo "Usage: $0 <action>. Where action is one of:" $(compgen -A function) && exit 1; fi
